{% extends 'base.html' %}

{% block title %}Bulk Create Schedules{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Header Section -->
    <div class="mb-6">
        <div class="flex items-center space-x-3 mb-2">
            <a href="{% url 'appointments:schedule_list' %}" 
               class="text-gray-400 hover:text-gray-600 transition duration-150 ease-in-out">
                ← Back to Schedules
            </a>
        </div>
        <h1 class="text-2xl font-bold text-gray-900">Bulk Create Schedules</h1>
        <p class="mt-1 text-sm text-gray-600">
            Create multiple schedule entries efficiently. Select a dentist, date range, and working hours pattern.
        </p>
    </div>

    <!-- Instructions Card -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
        <div class="flex">
            <div class="ml-3">
                <p class="text-sm text-blue-700">
                    <strong>How it works:</strong> Choose a dentist and date range, then select which days of the week to create schedules for. 
                    You can set different time slots for morning and afternoon sessions. Holidays will be automatically skipped.
                </p>
            </div>
        </div>
    </div>

    <div class="bg-white shadow-sm rounded-lg">
        <form method="post" id="bulkCreateForm" x-data="bulkCreateSchedule()">
            {% csrf_token %}
            
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Schedule Configuration</h2>
            </div>

            <div class="p-6 space-y-6">
                <!-- Dentist Selection -->
                <div>
                    <label for="dentist" class="block text-sm font-medium text-gray-700 mb-2">
                        Dentist <span class="text-red-500">*</span>
                    </label>
                    <select name="dentist" id="dentist" required 
                            x-model="selectedDentist"
                            @change="loadDentistTemplate()"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        <option value="">Select a dentist...</option>
                        {% for dentist in dentists %}
                            <option value="{{ dentist.id }}">{{ dentist.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Load Template Button -->
                <div x-show="selectedDentist" x-transition class="bg-gray-50 p-4 rounded-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-sm font-medium text-gray-700">Quick Setup</h4>
                            <p class="text-sm text-gray-500">Load this dentist's weekly working hours template</p>
                        </div>
                        <button type="button" 
                                @click="loadTemplate()" 
                                :disabled="templateLoading"
                                :class="templateLoading ? 'bg-gray-300 cursor-not-allowed' : 'bg-white hover:bg-gray-50'"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition duration-150">
                            <span x-show="!templateLoading">Load Template</span>
                            <span x-show="templateLoading">Loading...</span>
                        </button>
                    </div>
                </div>

                <!-- Date Range -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start_date" class="block text-sm font-medium text-gray-700 mb-2">
                            Start Date <span class="text-red-500">*</span>
                        </label>
                        <input type="date" name="start_date" id="start_date" required
                               min="{{ today|date:'Y-m-d' }}"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="end_date" class="block text-sm font-medium text-gray-700 mb-2">
                            End Date <span class="text-red-500">*</span>
                        </label>
                        <input type="date" name="end_date" id="end_date" required
                               min="{{ today|date:'Y-m-d' }}"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                    </div>
                </div>

                <!-- Days of Week Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        Working Days <span class="text-red-500">*</span>
                    </label>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                        {% for day_num, day_name in days_of_week %}
                            <label class="relative flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" name="days_of_week" value="{{ day_num }}" 
                                       class="sr-only peer"
                                       {% if day_num < 5 %}checked{% endif %}>
                                <div class="flex flex-col items-center w-full">
                                    <div class="w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center peer-checked:border-primary-500 peer-checked:bg-primary-500 peer-checked:text-white text-sm font-medium transition-all">
                                        {{ day_name|slice:":1" }}
                                    </div>
                                    <span class="mt-1 text-xs text-gray-600 peer-checked:text-primary-600 font-medium">{{ day_name|slice:":3" }}</span>
                                </div>
                            </label>
                        {% endfor %}
                    </div>
                    <p class="mt-2 text-xs text-gray-500">Monday to Friday are selected by default</p>
                </div>

                <!-- Time Slots Configuration -->
                <div class="space-y-6">
                    <h3 class="text-lg font-medium text-gray-900">Time Slots</h3>
                    
                    <!-- Morning Session -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="enable_morning" name="enable_morning" 
                                   x-model="enableMorning"
                                   class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                            <label for="enable_morning" class="ml-2 text-sm font-medium text-gray-700">
                                Morning Session
                            </label>
                        </div>
                        
                        <div x-show="enableMorning" x-transition class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="morning_start" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                                <input type="time" name="morning_start" id="morning_start" 
                                       value="10:00"
                                       :required="enableMorning"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="morning_end" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                                <input type="time" name="morning_end" id="morning_end" 
                                       value="12:00"
                                       :required="enableMorning"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Afternoon Session -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="enable_afternoon" name="enable_afternoon" 
                                   x-model="enableAfternoon"
                                   checked
                                   class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                            <label for="enable_afternoon" class="ml-2 text-sm font-medium text-gray-700">
                                Afternoon Session
                            </label>
                        </div>
                        
                        <div x-show="enableAfternoon" x-transition class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="afternoon_start" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                                <input type="time" name="afternoon_start" id="afternoon_start" 
                                       value="13:00"
                                       :required="enableAfternoon"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="afternoon_end" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                                <input type="time" name="afternoon_end" id="afternoon_end" 
                                       value="18:00"
                                       :required="enableAfternoon"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Options -->
                <div class="bg-gray-50 p-4 rounded-md">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">Additional Options</h4>
                    
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" name="skip_holidays" value="1" checked
                                   class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">Skip holidays automatically</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" name="skip_existing" value="1" checked
                                   class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">Skip dates with existing schedules</span>
                        </label>
                    </div>
                </div>

                <!-- Preview Section -->
                <div x-show="selectedDentist" x-transition class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                    <h4 class="text-sm font-medium text-yellow-800 mb-2">Preview</h4>
                    <p class="text-sm text-yellow-700" x-text="getPreviewText()"></p>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                <a href="{% url 'appointments:schedule_list' %}" 
                   class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </a>
                
                <button type="submit" 
                        :disabled="!canSubmit()"
                        :class="canSubmit() ? 'bg-primary-600 hover:bg-primary-700 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
                        class="inline-flex items-center px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium transition-colors duration-150">
                    Create Schedules
                </button>
            </div>
        </form>
    </div>

    <!-- Help Section -->
    <div class="mt-6 bg-white border border-gray-200 rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Tips & Guidelines</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h4 class="text-sm font-medium text-gray-700 mb-2">Time Slots</h4>
                <ul class="text-sm text-gray-600 space-y-1">
                    <li>• Morning: Typically 10:00 AM - 12:00 PM</li>
                    <li>• Afternoon: Typically 1:00 PM - 6:00 PM</li>
                    <li>• Leave 1-hour lunch break between sessions</li>
                    <li>• Each session should be at least 1 hour long</li>
                </ul>
            </div>
            <div>
                <h4 class="text-sm font-medium text-gray-700 mb-2">Best Practices</h4>
                <ul class="text-sm text-gray-600 space-y-1">
                    <li>• Create schedules 1-2 months in advance</li>
                    <li>• Check dentist availability before bulk creation</li>
                    <li>• Holidays will be automatically skipped</li>
                    <li>• Existing schedules won't be overwritten</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
function bulkCreateSchedule() {
    return {
        selectedDentist: '',
        enableMorning: false,
        enableAfternoon: true,
        
        loadDentistTemplate() {
            // In a real implementation, this would fetch the dentist's weekly template
            console.log('Loading template for dentist:', this.selectedDentist);
        },
        
        loadTemplate() {
            // Mock loading template data
            this.enableMorning = true;
            this.enableAfternoon = true;
            
            // You would make an AJAX call here to fetch the dentist's DentistSchedule
            // and populate the form fields accordingly
            console.log('Template loaded for dentist:', this.selectedDentist);
        },
        
        getPreviewText() {
            if (!this.selectedDentist) return 'Select a dentist to see preview';
            
            let sessions = [];
            if (this.enableMorning) sessions.push('Morning');
            if (this.enableAfternoon) sessions.push('Afternoon');
            
            if (sessions.length === 0) return 'Select at least one time session';
            
            return `Will create ${sessions.join(' and ')} sessions for the selected date range`;
        },
        
        canSubmit() {
            return this.selectedDentist && (this.enableMorning || this.enableAfternoon);
        }
    }
}
</script>

{% endblock %}